version: '3'

vars:
  TERRAFORM_DIR: ./infrastructure/terraform
  PROJECT_NAME: poe-accountant

tasks:
  init:
    desc: Initialize Terraform in the infrastructure/terraform directory
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - tofu init

  init:upgrade:
    desc: Initialize Terraform with provider upgrades
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - tofu init -upgrade

  plan:
    desc: Run Terraform plan to see what changes will be made
    dir: "{{.TERRAFORM_DIR}}"
    deps: [validate]
    cmds:
      - tofu plan

  plan:destroy:
    desc: Run Terraform plan for destroy to see what will be destroyed
    dir: "{{.TERRAFORM_DIR}}"
    deps: [validate]
    cmds:
      - tofu plan -destroy

  apply:
    desc: Apply Terraform changes
    dir: "{{.TERRAFORM_DIR}}"
    deps: [validate, check:token]
    cmds:
      - tofu apply

  apply:auto:
    desc: Apply Terraform changes without interactive approval
    dir: "{{.TERRAFORM_DIR}}"
    deps: [validate, check:token]
    cmds:
      - tofu apply -auto-approve

  redeploy:helm:
    desc: Force redeploy Helm release by tainting and applying
    dir: "{{.TERRAFORM_DIR}}"
    deps: [taint:helm, validate, check:token]
    cmds:
      - tofu apply -auto-approve

  destroy:
    desc: Destroy Terraform-managed infrastructure
    dir: "{{.TERRAFORM_DIR}}"
    deps: [validate]
    prompt: Are you sure you want to DESTROY all Terraform-managed infrastructure?
    cmds:
      - tofu destroy

  destroy:auto:
    desc: Destroy Terraform-managed infrastructure without interactive approval
    dir: "{{.TERRAFORM_DIR}}"
    deps: [validate]
    cmds:
      - tofu destroy -auto-approve

  validate:
    desc: Validate Terraform configuration files
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - tofu validate

  check:token:
    desc: Check if DigitalOcean token is configured
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - |
        if [ -z "$DIGITALOCEAN_TOKEN" ]; then
          echo "❌ Error: DigitalOcean token not found!"
          echo "Please set one of the following:"
          echo "  1. Environment variable: export DIGITALOCEAN_TOKEN=\"your-token\""
          exit 1
        fi
        echo "✅ DigitalOcean token found and configured correctly"

  format:
    desc: Format Terraform configuration files
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - tofu fmt -recursive

  format:check:
    desc: Check if Terraform files are properly formatted
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - tofu fmt -check -recursive

  show:
    desc: Show current Terraform state
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - tofu show

  state:list:
    desc: List all resources in Terraform state
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - tofu state list

  state:show:
    desc: "Show details of a specific resource (usage: task terraform:state:show -- <resource_name>)"
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - tofu state show {{.CLI_ARGS}}

  taint:helm:
    desc: Taint the Helm release to force recreation on next apply
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - tofu taint module.helm.helm_release.poe_accountant

  taint:
    desc: "Taint a specific resource (usage: task terraform:taint -- <resource_name>)"
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - tofu taint {{.CLI_ARGS}}

  output:
    desc: Show Terraform outputs
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - tofu output

  output:json:
    desc: Show Terraform outputs in JSON format
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - tofu output -json

  kubectl:setup:
    desc: Configure kubectl to connect to the Kubernetes cluster using Terraform outputs
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - |
        echo "Setting up kubectl connection to Kubernetes cluster..."
        
        # Get cluster info from Terraform outputs
        CLUSTER_ENDPOINT=$(tofu output -raw cluster_endpoint)
        CLUSTER_TOKEN=$(tofu output -raw cluster_token)
        CLUSTER_CA_CERT=$(tofu output -raw cluster_ca_certificate)
        CLUSTER_NAME="{{.PROJECT_NAME}}-cluster"
        
        # Create temporary file for CA certificate
        CA_CERT_FILE=$(mktemp)
        echo "$CLUSTER_CA_CERT" | base64 -d > "$CA_CERT_FILE"
        
        # Create kubeconfig context
        kubectl config set-cluster $CLUSTER_NAME \
          --server="$CLUSTER_ENDPOINT" \
          --certificate-authority="$CA_CERT_FILE" \
          --embed-certs=true
        
        kubectl config set-credentials $CLUSTER_NAME-admin \
          --token="$CLUSTER_TOKEN"
        
        kubectl config set-context $CLUSTER_NAME \
          --cluster=$CLUSTER_NAME \
          --user=$CLUSTER_NAME-admin
        
        kubectl config use-context $CLUSTER_NAME
        
        # Clean up temporary file
        rm -f "$CA_CERT_FILE"
        
        echo "✅ kubectl configured successfully!"
        echo "Current context: $(kubectl config current-context)"
        echo "Cluster info:"
        kubectl cluster-info

  workspace:list:
    desc: List Terraform workspaces
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - tofu workspace list

  workspace:new:
    desc: "Create new Terraform workspace (usage: task terraform:workspace:new -- <workspace_name>)"
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - tofu workspace new {{.CLI_ARGS}}

  workspace:select:
    desc: "Select Terraform workspace (usage: task terraform:workspace:select -- <workspace_name>)"
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - tofu workspace select {{.CLI_ARGS}}

  clean:
    desc: Clean Terraform cache and temporary files
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - rm -rf .terraform
      - rm -f .terraform.lock.hcl
      - rm -f terraform.tfstate.backup

  lint:
    desc: Run comprehensive checks (format check + validate)
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - tofu fmt -check -recursive
      - tofu validate

  refresh:
    desc: Refresh Terraform state to match real infrastructure
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - tofu refresh

  import:
    desc: "Import existing resource into Terraform state (usage: task terraform:import -- <resource_type.name> <resource_id>)"
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - tofu import {{.CLI_ARGS}}

  graph:
    desc: Generate and display Terraform dependency graph
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - tofu graph | dot -Tsvg > terraform-graph.svg
      - echo "Graph saved to terraform-graph.svg"

  version:
    desc: Show OpenTofu version
    cmds:
      - tofu version
