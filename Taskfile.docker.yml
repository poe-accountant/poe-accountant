version: '3'

tasks:
  build:ninja-server:
    cmds:
      - echo "üî® Building Ninja Server..."
      - docker build --build-arg WORKSPACE=ninja-server -t poe-accountant-ninja-server:latest -f ./projects/yarn.Dockerfile .
      - echo "‚úÖ Ninja Server built successfully!"

  build:all:
    deps: [build:ninja-server]
    cmds:
      - echo "‚úÖ All Docker images built successfully!"

  push:registry:
    desc: Push Docker images to the DigitalOcean registry from Terraform outputs
    deps: [build:all]
    cmds:
      - |
        echo "üöÄ Pushing images to DigitalOcean registry..."
        
        # Get registry endpoint from Terraform outputs
        cd infrastructure/terraform
        REGISTRY_ENDPOINT=$(tofu output -raw registry_endpoint)
        
        echo "Registry endpoint: $REGISTRY_ENDPOINT"
        
        # Tag and push ninja-server
        docker tag poe-accountant-ninja-server:latest $REGISTRY_ENDPOINT/poe-accountant-ninja-server:latest
        docker push $REGISTRY_ENDPOINT/poe-accountant-ninja-server:latest
        
        echo "‚úÖ All images pushed successfully to $REGISTRY_ENDPOINT!"

  login:registry:
    desc: Login to the DigitalOcean registry using doctl
    cmds:
      - |
        echo "üîê Logging into DigitalOcean registry..."
        
        # Initialize doctl auth with DigitalOcean token
        echo "Initializing doctl authentication..."
        doctl auth init --access-token $DIGITALOCEAN_TOKEN
        
        # Get registry name from Terraform outputs for reference
        cd infrastructure/terraform
        REGISTRY_NAME=$(tofu output -raw registry_name)
        
        echo "Registry name: $REGISTRY_NAME"
        doctl registry login
        
        echo "‚úÖ Successfully logged into registry!"

  deploy:
    desc: Build, login, and push all images to registry
    deps: [login:registry, push:registry]
    cmds:
      - echo "‚úÖ Complete deployment pipeline finished!"
