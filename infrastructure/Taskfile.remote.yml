version: '3'

includes:
  terraform:
    taskfile: ./terraform/Taskfile.yml
    dir: ./terraform
  helm:
    taskfile: ./helm/Taskfile.yml
    dir: ./helm

tasks:
  create:
    desc: Create the complete remote infrastructure (Terraform apply + kubectl setup)
    cmds:
      - |
        echo "ğŸš€ Creating remote infrastructure..."
        echo ""
        echo "ğŸ“‹ Step 1: Applying Terraform configuration..."
      - task: terraform:apply

  setup:
    desc: Setup kubectl configuration using setup script
    cmds:
      - echo "ğŸ”§ Initializing Terraform..."
      - task: terraform:init

  destroy:
    desc: Destroy the complete remote infrastructure
    cmds:
      - task: terraform:destroy

  status:
    desc: Show status of remote infrastructure
    cmds:
      - echo "ğŸ“Š Remote Infrastructure Status"
      - echo "==============================="
      - echo ""
      - echo "ğŸ—ï¸  Terraform Resources:"
      - task: infrastructure:terraform:show

  outputs:
    desc: Show remote infrastructure outputs
    cmds:
      - echo "ğŸ“‹ Remote Infrastructure Outputs"
      - echo "================================="
      - task: infrastructure:terraform:output

  validate:
    desc: Validate remote infrastructure configuration
    cmds:
      - echo "âœ… Validating remote infrastructure..."
      - echo ""
      - echo "ğŸ” Terraform validation:"
      - task: infrastructure:terraform:validate
      - echo ""
      - echo "ğŸ” Terraform format check:"
      - task: infrastructure:terraform:format:check
      - echo ""
      - echo "âœ… Remote infrastructure validation complete!"

  registry:push:
    desc: Push Docker images to the DigitalOcean registry from Terraform outputs
    deps: [registry:login]
    cmds:
      - |
        cd terraform
        REGISTRY_ENDPOINT=$(tofu output -raw registry_endpoint)

        echo "Registry endpoint: $REGISTRY_ENDPOINT"

        docker tag poe-accountant-ninja-server:latest $REGISTRY_ENDPOINT/poe-accountant-ninja-server:latest
        docker push $REGISTRY_ENDPOINT/poe-accountant-ninja-server:latest

        docker tag poe-accountant-api-server:latest $REGISTRY_ENDPOINT/poe-accountant-api-server:latest
        docker push $REGISTRY_ENDPOINT/poe-accountant-api-server:latest

  login:
    desc: Login to the DigitalOcean registry using doctl
    cmds:
      - |
        # Initialize doctl auth with DigitalOcean token
        echo "Initializing doctl authentication..."
        doctl auth init --access-token $DIGITALOCEAN_TOKEN

        # Get registry name from Terraform outputs for reference
        cd terraform
        REGISTRY_NAME=$(tofu output -raw registry_name)

        echo "Registry name: $REGISTRY_NAME"
        doctl registry login

  helm:
    cmds:
      - helm {{.CLI_ARGS}}
